# 前置き
コマンドライン引数を扱うとき、普通は先頭から順に調べていくことになるが、それだと扱いづらい。
本の筆者はコマンドライン引数を扱うユーティリティを自作することにした。  
Argsというクラスのインスタンスを書式（スキーマ文字列）とコマンドライン引数の二つの引数で作成するつくりになっている。  
引数に問題がある場合はコンストラクタがArgsExceptionを返し、そうでない場合はgetIntやgetStringのようなメソッドで引数の値にアクセスできる。  

本の筆者は一気に綺麗なコードを書き上げたわけではなく、まず汚いコードを書き始めてそれを徐々に綺麗にしていったらしい。

## Args 初期バージョン
大量のフィールドがあり、int, boolean, stringなどの場合どのように処理されるのかがArgsクラス内で別々に記述されており、詳細が漏れている。  
booleanのみを対象としていた段階ではまだそこまでコードが汚くなっていなかったらしく、intやstringを追加したことで一気にコードが分かりづらくなってしまったようだ。

## リファクタリングの開始
更に2つの型を追加する必要があり、明らかにさらにコードが酷くなりそうだったので、いったんそのタイミングでリファクタリングを開始したらしい。  
intとstringの追加を行ったことで、新しい型の追加を行うために、3か所に新しくコードを書くことがわかったらしい。
- スキーマ文字列のパース
- コマンドライン引数をパースして本来の型に戻す
- 本来の型で呼び出し元に値を返すgetXXXメソッド  

これらは全て別々の型に対して同じような処理（メソッド）が必要になるケースの為、新たなインターフェイス ArgumentMarshalerと、それを実装したBooleanArgumentMarshalerみたいなクラスを型毎に用意することにしたようだ。

### TDD
コードをリファクタする際に一番マズいのは、リファクタ前と同じように動かなくなることで、これを避けるためにTDD テスト駆動開発という手法を用いる。  
つまり、コードを書く前に必要な自動テストを用意しておく。  
筆者は単体テストをJUnitで管理し、受け入れテストをFitNesseというツールで実行したらしい。  
とりあえず単体テストが通る状態を維持しながら変更していけばコードが動かなくなる心配をせずにリファクタができる。

### ArgumentMarshalerの追加
できるだけシステムの変更が最小限に済むように、まずはArgumentMarshalerを追加するだけにしたらしい。  
その後、Boolean引数用のHashMapを、BooleanではなくArgumentMarshalerを保持するように変更したところ、いくつかのテストが動かなくなった。  
直ちにテストが動くように修正を行い、不要になったメソッドを削除した。
次に文字列の場合を同じように追加し、テストが失敗したらすぐ成功するように修正した。  
ArgumentMarshalerの中に一旦文字列引数の処理を書いて、後でそれを継承するクラスに落とし込んでいくためこの段階では全てベースクラスに書かれていたらしい。

### ベースクラスから継承クラスへの機能の移動
intの処理もArgumentMarshalerに追加してテストが通るように直したら、次に継承クラスに機能を移動していったらしい。  
まずベースクラスのsetBooleanメソッドを継承メソッドに移動するため、set抽象メソッドを作成し継承メソッドに実装していった。  
最後に、呼び出し側をsetBooleanからsetに変更した。
BooleanArgumentMarshalerのsetメソッドでは取っている文字列引数を使っていないが、Stringとかでは使いそうだったので用意したとのこと（かなり強引な感じがするけど）  
更にgetメソッドも追加。これはBooleanやintなどが返ってくるので返り値をObject型にせざるを得ない。  
とりあえずベースクラスにget関数を追加→abstractにして継承クラスで実装してテストを通した。これでgetXXXを削除できるようになって、それぞれのvalueフィールドも各継承クラスに移動できるようになった。  
intの場合パースが必要で、パースに失敗すると例外を吐くがこの例外はIntegerArgumentMarshaler内でArgsExceptionとしてラップすることで隠蔽できた。  
そして各型毎のHashMapを削除するために一つ一つ、テストを実行しながら処理を書き換えていった。

### メモ
リファクタ時には、同じようなコードを消したり再度書いたりすることが何度も発生するものらしい。  
